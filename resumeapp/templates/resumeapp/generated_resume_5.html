{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Resume Template 5</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: #f6f3ff;
      font-family: 'Poppins', sans-serif;
      padding: 40px;
      color: #2e2e2e;
    }
    .header {
      background: linear-gradient(135deg, #6a0dad, #9b59b6);
      color: white;
      text-align: center;
      padding: 35px;
      border-radius: 15px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    .section {
      background: white;
      margin-top: 25px;
      padding: 22px;
      border-radius: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    h5 {
      color: #6a0dad;
      border-bottom: 2px solid #6a0dad;
      padding-bottom: 5px;
      margin-bottom: 15px;
      font-weight: 600;
    }
    ul { margin-bottom: 0; }
    .btn { border-radius: 8px; }
  </style>
</head>
<body>
  <div id="resumeContent">
    <div class="header">
      <h2 id="fullName"></h2>
      <p>
        <span id="email"></span> | 
        <span id="phone"></span> | 
        <span id="address"></span> | 
        <span id="linkedin"></span> | 
        <span id="github"></span>
      </p>
    </div>

    <div class="section" id="objectiveSection"></div>
    <div class="section" id="educationSection"></div>
    <div class="section" id="skillsSection"></div>
    <div class="section" id="projectsSection"></div>
    <div class="section" id="experienceSection"></div>
  </div>

  <div class="text-center mt-4 no-print">
    <button class="btn btn-primary px-4" onclick="downloadPDF()">⬇ Download PDF</button>
    <a href="{% url 'template_selection' %}" class="btn btn-secondary ms-2 px-4">Back</a>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
window.onload = () => {
  const setText = (id, key) => {
    const v = localStorage.getItem(key);
    if (v && v.trim() !== "") document.getElementById(id).innerText = v;
    else document.getElementById(id)?.remove();
  };

  // ====== PERSONAL INFO ======
  setText("fullName","id_full_name");
  setText("email","id_email");
  setText("phone","id_phone");
  setText("address","id_address");
  setText("linkedin","id_linkedin");
  setText("github","id_github");

  // ====== OBJECTIVE ======
  const obj = localStorage.getItem("id_objective");
  if (obj && obj.trim() !== "") {
    document.getElementById("objectiveSection").innerHTML = `
      <h5>Objective</h5><p>${obj}</p>`;
  } else document.getElementById("objectiveSection").remove();

  // ====== UNIVERSAL SAFE PARSER ======
  const safeGet = (obj, key) => obj?.[key] || obj?.fields?.[key] || "";

  // ====== SECTIONS ======
  const sections = [
    ["eduList","educationSection","Education", e => `${safeGet(e,'level')} - ${safeGet(e,'institute')} (${safeGet(e,'year')}) ${safeGet(e,'percentage') ? '- ' + safeGet(e,'percentage') + '%' : ''}`],
    ["skillList","skillsSection","Skills", s => `${safeGet(s,'skill')} ${safeGet(s,'level') ? '(' + safeGet(s,'level') + ')' : ''}`],
    ["projList","projectsSection","Projects", p => `<b>${safeGet(p,'title')}</b> - ${safeGet(p,'tech')}<br>${safeGet(p,'description')}`],
    ["expList","experienceSection","Experience", x => `<b>${safeGet(x,'role')}</b> at ${safeGet(x,'company')} (${safeGet(x,'duration')})<br>${safeGet(x,'description')}`]
  ];

  sections.forEach(([key,id,title,fmt])=>{
    const list = JSON.parse(localStorage.getItem(key) || "[]");
    if (list.length > 0) {
      document.getElementById(id).innerHTML = `
        <h5>${title}</h5>
        <ul>${list.map(e => `<li>${fmt(e)}</li>`).join('')}</ul>`;
    } else document.getElementById(id).remove();
  });
};

// ====== MULTI-PAGE PDF GENERATION ======
async function downloadPDF() {
  const btn = document.querySelector(".btn-primary, .btn-success");
  const originalText = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Generating...`;

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "a4");
    const element = document.getElementById("resumeContent");

    document.querySelectorAll(".no-print, .btn, a").forEach(el => el.style.display = "none");

    const canvas = await html2canvas(element, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");

    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
    const pageHeight = doc.internal.pageSize.getHeight();

    let heightLeft = pdfHeight;
    let position = 0;

    doc.addImage(imgData, "PNG", 0, position, pdfWidth, pdfHeight);
    heightLeft -= pageHeight;

    while (heightLeft > 0) {
      position = heightLeft - pdfHeight;
      doc.addPage();
      doc.addImage(imgData, "PNG", 0, position, pdfWidth, pdfHeight);
      heightLeft -= pageHeight;
    }

    doc.save("My_Resume.pdf");

    document.querySelectorAll(".no-print, .btn, a").forEach(el => el.style.display = "inline-block");
    btn.innerHTML = "✅ Downloaded!";
    setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 2000);

  } catch (error) {
    console.error("PDF Generation Error:", error);
    btn.innerHTML = "❌ Error, Try Again";
    setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 2000);
  }
}
</script>

</body>
</html>
