{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Generated Resume - Template {{ template_id }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #fff;
      padding: 40px;
      font-family: Inter, Arial, sans-serif;
      color: #333;
    }
    #resumeContent {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 30px 50px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2, h5 { color: #2c3e50; }
    .section-title {
      border-bottom: 2px solid #007bff;
      margin-top: 25px;
      padding-bottom: 4px;
    }
    ul { list-style: disc; margin-left: 20px; }
    .text-center { text-align: center; }
    .btn { border-radius: 8px; }
    .no-print { /* Hide elements during PDF generation */
      display: block;
    }
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <div id="resumeContent" class="container">
    <h2 id="fullName" class="text-center mb-2"></h2>
    <p class="text-center mb-1">
      <span id="email"></span> |
      <span id="phone"></span> |
      <span id="linkedin"></span> |
      <span id="github"></span>
    </p>
    <p class="text-center mb-4" id="address"></p>

    <div id="objectiveSection"></div>
    <div id="educationSection"></div>
    <div id="skillsSection"></div>
    <div id="projectsSection"></div>
    <div id="experienceSection"></div>

    <!-- Buttons (excluded from PDF) -->
    <div class="text-center mt-5 no-print">
      <button class="btn btn-success px-4" onclick="downloadPDF()">⬇ Download Resume (PDF)</button>
      <a href="{% url 'template_selection' %}" class="btn btn-secondary ms-2 px-4">Back</a>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  window.onload = () => {
    // ===== PERSONAL INFO =====
    document.getElementById("fullName").innerText = localStorage.getItem("id_full_name") || "";
    document.getElementById("email").innerText = localStorage.getItem("id_email") || "";
    document.getElementById("phone").innerText = localStorage.getItem("id_phone") || "";
    document.getElementById("linkedin").innerText = localStorage.getItem("id_linkedin") || "";
    document.getElementById("github").innerText = localStorage.getItem("id_github") || "";
    document.getElementById("address").innerText = localStorage.getItem("id_address") || "";

    // ===== OBJECTIVE =====
    const obj = localStorage.getItem("id_objective");
    if (obj && obj.trim() !== "") {
      document.getElementById("objectiveSection").innerHTML = `
        <h5 class='section-title'>Objective</h5>
        <p>${obj}</p>`;
    }

    // ===== EDUCATION =====
    const eduList = JSON.parse(localStorage.getItem("eduList") || "[]");
    if (eduList.length > 0) {
      document.getElementById("educationSection").innerHTML = `
        <h5 class='section-title'>Education</h5>
        <ul>${eduList.map(e => `
          <li>
            <b>${e.level || ""}</b> - ${e.institute || ""} (${e.year || ""})<br>
            ${(e.boardOrDegree || "")}${e.percentage ? ", " + e.percentage + "%" : ""}
          </li>`).join('')}
        </ul>`;
    }

    // ===== SKILLS =====
    const skillList = JSON.parse(localStorage.getItem("skillList") || "[]");
    if (skillList.length > 0) {
      document.getElementById("skillsSection").innerHTML = `
        <h5 class='section-title'>Skills</h5>
        <ul>${skillList.map(s => `<li>${s.skill || ""} ${s.level ? "(" + s.level + ")" : ""}</li>`).join('')}</ul>`;
    }

    // ===== PROJECTS =====
    const projList = JSON.parse(localStorage.getItem("projList") || "[]");
    if (projList.length > 0) {
      document.getElementById("projectsSection").innerHTML = `
        <h5 class='section-title'>Projects</h5>
        <ul>${projList.map(p => `
          <li>
            <b>${p.title || ""}</b> - ${p.tech || ""}<br>${p.description || ""}
          </li>`).join('')}
        </ul>`;
    }

    // ===== EXPERIENCE =====
    const expList = JSON.parse(localStorage.getItem("expList") || "[]");
    if (expList.length > 0) {
      document.getElementById("experienceSection").innerHTML = `
        <h5 class='section-title'>Experience</h5>
        <ul>${expList.map(x => `
          <li>
            <b>${x.role || ""}</b> at ${x.company || ""} (${x.duration || ""})<br>${x.description || ""}
          </li>`).join('')}
        </ul>`;
    }
  };

  // ===== DOWNLOAD AS MULTI-PAGE PDF =====
  async function downloadPDF() {
    const btn = document.querySelector(".btn-success");
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Generating...`;

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "pt", "a4");

      // Hide buttons before generating PDF
      document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');

      const element = document.getElementById("resumeContent");
      const canvas = await html2canvas(element, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");

      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      const pageHeight = doc.internal.pageSize.getHeight();

      let heightLeft = pdfHeight;
      let position = 0;

      doc.addImage(imgData, "PNG", 0, position, pdfWidth, pdfHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - pdfHeight;
        doc.addPage();
        doc.addImage(imgData, "PNG", 0, position, pdfWidth, pdfHeight);
        heightLeft -= pageHeight;
      }

      doc.save("My_Resume.pdf");

      // Restore buttons
      document.querySelectorAll('.no-print').forEach(el => el.style.display = 'block');

      btn.innerHTML = "✅ Downloaded!";
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }, 2000);
    } catch (error) {
      console.error("PDF Generation Error:", error);
      btn.innerHTML = "❌ Error, Try Again";
      setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }, 2000);
    }
  }
  </script>
</body>
</html>
